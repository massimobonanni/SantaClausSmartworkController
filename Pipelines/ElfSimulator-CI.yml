trigger:
 branches:
  include:
     - main
 paths:
  include:
   - SCSC.APIClient
   - SCSC.Core
   - SCSC.ElfSimulator

name: ElfSimulator_$(Date:yyyyMMdd)$(Rev:.r)

variables:
  vmImageName: 'windows-2022'
  dockerImageTag : $(Date:yyyyMMdd)$(Rev:.r)

pool:
  vmImage: $(vmImageName)

steps:
- task: DotNetCoreCLI@2
  name: RestoreCoreComponent
  displayName: 'Restore SCSC.Core references'
  inputs:
    command: 'restore'
    projects: 'SCSC.Core/SCSC.Core.csproj'
    feedsToUse: 'select'

- task: DotNetCoreCLI@2
  name: BuildCoreComponent
  displayName: 'Build SCSC.Core project'
  inputs:
    command: 'build'
    projects: 'SCSC.Core/SCSC.Core.csproj'

- task: DotNetCoreCLI@2
  name: BuildCoreTests
  displayName: 'Build SCSC.Core.Test project'
  inputs:
    command: 'build'
    projects: 'Tests/SCSC.Core.Test/SCSC.Core.Test.csproj'

- task: VSTest@2
  inputs:
    testSelector: 'testAssemblies'
    testAssemblyVer2: |
      Tests\**\*SCSC.Core.Test*.dll
      !**\*TestAdapter.dll
      !**\obj\**
    searchFolder: '$(System.DefaultWorkingDirectory)'

- task: DotNetCoreCLI@2
  name: RestoreAPIClientComponent
  displayName: 'Restore SCSC.APIClient references'
  inputs:
    command: 'restore'
    projects: 'SCSC.APIClient/SCSC.APIClient.csproj'
    feedsToUse: 'select'

- task: DotNetCoreCLI@2
  name: BuildAPIClientComponent
  displayName: 'Build SCSC.APIClient project'
  inputs:
    command: 'build'
    projects: 'SCSC.APIClient/SCSC.APIClient.csproj'

- task: DotNetCoreCLI@2
  name: RestoreElfSimulatorComponent
  displayName: 'Restore SCSC.ElfSimulator references'
  inputs:
    command: 'restore'
    projects: 'SCSC.ElfSimulator/SCSC.ElfSimulator.csproj'
    feedsToUse: 'select'

- task: DotNetCoreCLI@2
  name: BuildElfSimulatorComponent
  displayName: 'Build SCSC.ElfSimulator project'
  inputs:
    command: 'build'
    projects: 'SCSC.ElfSimulator/SCSC.ElfSimulator.csproj'

- task: Docker@2
  displayName: Login to Docker Hub
  inputs:
    command: login
    containerRegistry: 'DockerHubConnection'

- task: Docker@2
  name: BuildElfSimulatorContainerImage
  displayName: 'Build SCSC.ElfSimulator Container Image'
  inputs:
    containerRegistry: 'DockerHubConnection'
    repository: 'ElfSimulator'
    command: 'buildAndPush'
    Dockerfile: 'SCSC.ElfSimulator/Dockerfile'
    tags: $(dockerImageTag)